# Пример обработки документа: Отчет по логам

## Исходные данные

**Файл:** `Договор_с_ИП_Молозин_П_Ю_СКС_версия_4.docx`  
**Размер:** 40,958 байт  
**Пользователь:** 261617302  
**Время обработки:** 2025-01-27

## Этап 1: Загрузка и валидация

```
🔍 [DEBUG] template_management_handler.handle_template_upload вызван
📄 [TEMPLATE] Пользователь 261617302 загрузил файл: Договор_с_ИП_Молозин_П_Ю_СКС_версия_4.docx (40958 байт)
📥 [TEMPLATE] Скачиваю файл Договор_с_ИП_Молозин_П_Ю_СКС_версия_4.docx...
✅ [TEMPLATE] Файл скачан успешно: 40958 байт
🤖 [TEMPLATE] Отправляю файл в Gemini для анализа...
```

**Результат:** Файл успешно загружен и готов к анализу.

## Этап 2: Детальная индексация документа

```
📄 [ANALYZE] Начинаю анализ документа размером 40958 байт
📖 [ANALYZE] Загружаю DOCX документ для детального анализа...
🔍 [ANALYZE] Создаю детальную индексацию на уровне run-ов...
🔍 [INDEX] Начинаю детальную индексацию документа на уровне run-ов...
```

### Анализ таблиц:
```
🔍 [ANALYZE] Анализирую структуру таблиц...
🔍 [TABLE_ANALYSIS] Начинаю анализ структуры таблиц...
🔍 [TABLE_ANALYSIS] Таблица 1:
   - Строк: 2, Столбцов: 2
   - Ячеек с содержимым: 3
   - Пустых ячеек: 0
   - Ячеек с подчеркиваниями: 1
   - Ячеек с пробелами: 0
✅ [TABLE_ANALYSIS] Анализ завершен: найдено 1 таблиц
```

### Создание карты для Gemini:
```
✅ [INDEX] Индексация завершена:
   - Создано 307 run-ов
   - Размер карты для Gemini: 10958 символов
   - Первые 500 символов карты: [run-0][run-1]    [run-2]                               [run-3] [run-4]Договор подряда [run-5]№ [run-6]10[run-7]-[run-8]0[run-9]-2[run-10]5[run-11]/[run-12]СКС

[run-13]г. Екатеринбург[run-14] [run-15]        [run-16]        [run-17]        [run-18]        [run-19]        [run-20]        [run-21]        [run-22]        [run-23] [run-24]         
      [run-25] [run-26] [run-27] [run-28]             [run-29]  [run-30]     [run-31]  [run-32]«[run-33]1[run-34]5[run-35]» [run-36]сентября[run-37] [run-38]20[run-39]2[run-40]5[run-41] года

[run-42]Об...
```

**Результат:** Документ разбит на 307 текстовых фрагментов (run'ов), создана карта для анализа AI.

## Этап 3: Отправка в Gemini AI

### Создание промпта:
```
🤖 [GEMINI] Отправляю карту документа в Gemini для анализа...
🔍 [GEMINI] Создан промпт длиной 15092 символов
🚀 [GEMINI] Отправляю запрос в Gemini API...
```

### Полный промпт для Gemini:
```
Ты — AI-юрист, эксперт по анализу юридических документов. Тебе предоставлена детальная карта документа, где каждый мельчайший текстовый фрагмент (`run`) имеет уникальный ID в формате `[run-ID]`.

**КАРТА ДОКУМЕНТА:**
---
[run-0][run-1]    [run-2]                               [run-3] [run-4]Договор подряда [run-5]№ [run-6]10[run-7]-[run-8]0[run-9]-2[run-10]5[run-11]/[run-12]СКС

[run-13]г. Екатеринбург[run-14] [run-15]        [run-16]        [run-17]        [run-18]        [run-19]        [run-20]        [run-21]        [run-22]        [run-23] [run-24]         
      [run-25] [run-26] [run-27] [run-28]             [run-29]  [run-30]     [run-31]  [run-32]«[run-33]1[run-34]5[run-35]» [run-36]сентября[run-37] [run-38]20[run-39]2[run-40]5[run-41] года

[run-42]Об...
---
[полная карта документа продолжается...]

**ТВОЯ ЗАДАЧА:**
1. Проанализируй карту: Изучи структуру документа. Определи 'Исполнителя' (заполненная сторона) и 'Заказчика' (сторона с пропусками).
2. Найди цели для правки: Найди фрагменты (`run`-ы), которые являются пропусками (`_______` или желтый текст) и относятся только к 'Заказчику'.
3. Определи назначение: Для каждого найденного `run`-а определи его юридическое назначение.
4. Классифицируй поля: Различай два типа полей:
   - Реквизиты организации — все поля, связанные с официальными данными компании
   - Другие поля — наименование организации, имя руководителя, должность
5. Определи зоны реквизитов: Если видишь таблицу с реквизитами у 'Исполнителя', то все соответствующие пропуски у 'Заказчика' помечай как единую область "реквизиты".
6. Сформируй "план правок": Верни ТОЛЬКО валидный JSON-массив.

**ПРИМЕР РЕЗУЛЬТАТА:**
```json
[
  { "run_id": "run-25", "field_name": "Полное наименование" },
  { "run_id": "run-156", "field_name": "реквизиты" },
  { "run_id": "run-158", "field_name": "реквизиты" },
  { "run_id": "run-160", "field_name": "Имя руководителя" }
]
```
```

### Ответ от Gemini:
```
✅ [GEMINI] Получен ответ от Gemini: 562 символов
🔍 [GEMINI] Первые 200 символов ответа: ```json
[
  { "run_id": "run-282", "field_name": "реквизиты" },
  { "run_id": "run-283", "field_name": "реквизиты" },
  { "run_id": "run-285", "field_name": "реквизиты" },
  { "run_id": "run-287", "fi
```

### Полный ответ Gemini:
```json
[
  { "run_id": "run-282", "field_name": "реквизиты" },
  { "run_id": "run-283", "field_name": "реквизиты" },
  { "run_id": "run-285", "field_name": "реквизиты" },
  { "run_id": "run-287", "field_name": "реквизиты" },
  { "run_id": "run-289", "field_name": "реквизиты" },
  { "run_id": "run-291", "field_name": "реквизиты" },
  { "run_id": "run-292", "field_name": "реквизиты" },
  { "run_id": "run-295", "field_name": "реквизиты" },
  { "run_id": "run-296", "field_name": "реквизиты" },
  { "run_id": "run-302", "field_name": "Подпись Заказчика" }
]
```

**Результат:** Gemini определил 10 полей для замены: 9 полей реквизитов + 1 поле подписи.

## Этап 4: Парсинг ответа Gemini

```
🔍 [GEMINI] Парсинг ответа от Gemini...
🔍 [PARSE] Начинаю парсинг плана правок от Gemini...
🔍 [PARSE] Длина ответа: 562 символов
🔍 [PARSE] Первые 200 символов ответа: ```json
[
  { "run_id": "run-282", "field_name": "реквизиты" },
  { "run_id": "run-283", "field_name": "реквизиты" },
  { "run_id": "run-285", "field_name": "реквизиты" },
  { "run_id": "run-287", "fi
🔍 [PARSE] Очищенный ответ: [
  { "run_id": "run-282", "field_name": "реквизиты" },
  { "run_id": "run-283", "field_name": "рекв...
🔍 [PARSE] Найден JSON массив: позиция 0 - 550
🔍 [PARSE] JSON текст: [
  { "run_id": "run-282", "field_name": "реквизиты" },
  { "run_id": "run-283", "field_name": "реквизиты" },
  { "run_id": "run-285", "field_name": "реквизиты" },
  { "run_id": "run-287", "field_name...
✅ [PARSE] Успешно распарсен JSON массив
```

### Валидация полей:
```
🔍 [PARSE] Проверяю элемент 0: {'run_id': 'run-282', 'field_name': 'реквизиты'}
✅ [PARSE] Найдено поле: run-282 -> 'реквизиты'
🔍 [PARSE] Проверяю элемент 1: {'run_id': 'run-283', 'field_name': 'реквизиты'}
✅ [PARSE] Найдено поле: run-283 -> 'реквизиты'
...
🔍 [PARSE] Проверяю элемент 9: {'run_id': 'run-302', 'field_name': 'Подпись Заказчика'}
✅ [PARSE] Найдено поле: run-302 -> 'Подпись Заказчика'
```

### Итоговый план правок:
```
🔍 [PARSE] Итоговый список валидных правок:
🔍 [PARSE] Всего полей: 10
🔍 [PARSE] Поля реквизитов: 9
🔍 [PARSE] Правка 1: run_id='run-282', field_name='реквизиты'
🔍 [PARSE] Правка 2: run_id='run-283', field_name='реквизиты'
🔍 [PARSE] Правка 3: run_id='run-285', field_name='реквизиты'
🔍 [PARSE] Правка 4: run_id='run-287', field_name='реквизиты'
🔍 [PARSE] Правка 5: run_id='run-289', field_name='реквизиты'
🔍 [PARSE] Правка 6: run_id='run-291', field_name='реквизиты'
🔍 [PARSE] Правка 7: run_id='run-292', field_name='реквизиты'
🔍 [PARSE] Правка 8: run_id='run-295', field_name='реквизиты'
🔍 [PARSE] Правка 9: run_id='run-296', field_name='реквизиты'
🔍 [PARSE] Правка 10: run_id='run-302', field_name='Подпись Заказчика'
✅ [REQUISITES] GEMINI определил 9 полей как 'реквизиты'
✅ [REQUISITES] Это означает, что все пустые строки в зоне реквизитов будут заменены на 'реквизиты'
✅ [GEMINI] Получен план правок от Gemini: 10 элементов
```

**Результат:** Успешно распарсен JSON с 10 валидными правками.

## Этап 5: Хирургические правки документа

### Создание независимых копий:
```
🔧 [ANALYZE] Применяю хирургические правки к документу...
🔧 [SURGERY] Начинаю хирургию run-ов...
🔧 [SURGERY] Получено 10 правок для применения
📋 [SURGERY] Создаю полностью независимые копии документа...
✅ [SURGERY] Созданы две полностью независимые копии документа
```

### Перестройка координат:
```
🔍 [SURGERY] Перестраиваю словари координат для копий...
🔍 [INDEX] Начинаю детальную индексацию документа на уровне run-ов...
🔍 [TABLE] Обрабатываю таблицу 1: 2 строк, 2 столбцов
✅ [INDEX] Индексация завершена:
   - Создано 307 run-ов
   - Размер карты для Gemini: 10958 символов
✅ [SURGERY] Словари координат перестроены:
   - Preview: 307 run-ов
   - Smart template: 307 run-ов
```

### Удаление желтой заливки:
```
🧹 [SURGERY] Удаляю желтую заливку из preview документа...
✅ [HIGHLIGHT] Удалена желтая заливка из run: '...'
✅ [HIGHLIGHT] Удалена желтая заливка из run: '    ...'
...
✅ [SURGERY] Желтая заливка удалена из preview документа
```

### Применение правок (примеры):

#### Правка 1: run-282 → реквизиты
```
🔧 [SURGERY] Правка 1/10: run_id='run-282', field_name='реквизиты'
🔍 [SURGERY] Найдены целевые run-ы:
   - Preview run text: '_______________________________...'
   - Smart template run text: '_______________________________...'
🔍 [REQUISITES] GEMINI приказал заменить run_id='run-282' на '[реквизиты]'
🎨 [SURGERY] Применяю правку к preview документу...
🔍 [DEBUG] Preview run ДО изменений: '_______________________________'
✅ [HIGHLIGHT] Удалена желтая заливка из run: '_______________________________...'
🔍 [DEBUG] Preview run ПОСЛЕ изменений: '[реквизиты]'
✅ [SURGERY] Preview run обновлен: '[реквизиты]' (красный, жирный)
✅ [VERIFY] Изменение подтверждено в preview run
🔧 [SURGERY] Применяю правку к smart template документу...
✅ [SURGERY] Smart template run обновлен: '{{реквизиты}}'
✅ [VERIFY] Изменение подтверждено в smart template run
```

#### Правка 10: run-302 → Подпись Заказчика
```
🔧 [SURGERY] Правка 10/10: run_id='run-302', field_name='Подпись Заказчика'
🔍 [SURGERY] Найдены целевые run-ы:
   - Preview run text: '____________________ ...'
   - Smart template run text: '____________________ ...'
🔍 [FIELD] GEMINI приказал заменить run_id='run-302' на 'Подпись Заказчика'
🎨 [SURGERY] Применяю правку к preview документу...
🔍 [DEBUG] Preview run ДО изменений: '____________________ '
✅ [HIGHLIGHT] Удалена желтая заливка из run: '____________________ ...'
🔍 [DEBUG] Preview run ПОСЛЕ изменений: '[Подпись Заказчика]'
✅ [SURGERY] Preview run обновлен: '[Подпись Заказчика]' (красный, жирный)
✅ [VERIFY] Изменение подтверждено в preview run
🔧 [SURGERY] Применяю правку к smart template документу...
✅ [SURGERY] Smart template run обновлен: '{{Подпись Заказчика}}'
✅ [VERIFY] Изменение подтверждено в smart template run
```

### Завершение хирургии:
```
✅ [SURGERY] Все правки применены к документам
```

## Этап 6: Анализ реквизитов

```
🔍 [REQUISITES] Анализ полей реквизитов после применения правок:
🔍 [REQUISITES] Всего полей реквизитов: 9
🔍 [REQUISITES] Поле 1: run_id='run-282'
🔍 [REQUISITES] Поле 2: run_id='run-283'
...
🔍 [REQUISITES] Поле 9: run_id='run-296'
```

### Проверка результата:
```
🔍 [DEBUG] Проверяю preview_doc после всех изменений...
🔍 [DEBUG] Preview документ содержит 0 полей: []
🔍 [REQUISITES] Найдено полей реквизитов в preview: 0
🔍 [DEBUG] Проверяю конкретные run'ы в preview_doc...
🔍 [DEBUG] Всего измененных run'ов в preview_doc: 0
```

**Примечание:** Здесь видна проблема - поля не были найдены в preview документе после изменений.

## Этап 7: Сохранение результатов

### Сохранение в байты:
```
💾 [SURGERY] Сохраняю документы в байты...
✅ [SURGERY] Preview документ сохранен: 37201 байт
🔍 [DEBUG] Проверяю содержимое preview документа...
🔍 [DEBUG] Preview текст (первые 200 символов):                                     Договор подряда № 10-09-25/СКСг. Екатеринбург                                                                                   «15» сентября 2025 годаОбщество с ограниченной ответственностью...
🔍 [DEBUG] Найдено полей в формате [Название]: 0
⚠️ [DEBUG] Поля в формате [Название] НЕ НАЙДЕНЫ в preview документе!
🔍 [DEBUG] Проверяю сохраненные байты...
✅ [VERIFY] Preview bytes сохранены: 37201 байт
✅ [SURGERY] Smart template документ сохранен: 37234 байт
```

### Итоговые размеры файлов:
- **Исходный файл:** 40,958 байт
- **Preview файл:** 37,201 байт (-3,757 байт)
- **Smart template файл:** 37,234 байт (-3,724 байт)

## Этап 8: Отчет о работе

### Общая статистика:
```
📊 [REPORT] === ОТЧЕТ О РАБОТЕ С РЕКВИЗИТАМИ ===
📊 [REPORT] Всего полей обработано: 10
📊 [REPORT] Поля реквизитов: 9
📊 [REPORT] Другие поля: 1
📊 [REPORT] Найдено таблиц: 1
📊 [REPORT] Таблица 1:
   - Размер: 2x2
   - Ячеек с содержимым: 3
   - Пустых ячеек: 0
   - Ячеек с подчеркиваниями: 1
   - Ячеек с пробелами: 0
```

### Анализ реквизитов:
```
📊 [REPORT] === АНАЛИЗ РЕКВИЗИТОВ ===
📊 [REPORT] GEMINI определил 9 полей как 'реквизиты'
📊 [REPORT] Это означает, что все пустые строки в зоне реквизитов будут заменены на 'реквизиты'
📊 [REPORT] Run ID полей реквизитов: ['run-282', 'run-283', 'run-285', 'run-287', 'run-289', 'run-291', 'run-292', 'run-295', 'run-296']
📊 [REPORT] Всего пустых ячеек в таблицах: 1
📊 [REPORT] Покрытие реквизитами: 9/1 ячеек
📊 [REPORT] === КОНЕЦ ОТЧЕТА ===
```

## Этап 9: Отправка пользователю

### Подготовка к отправке:
```
✅ [TEMPLATE] Анализ завершен
✅ [TEMPLATE] Созданы файлы:
   - Предпросмотр: 37201 байт
   - Умный шаблон: 37234 байт
📄 [TEMPLATE] Отправляю файл предпросмотра пользователю...
🔍 [DEBUG] Preview bytes размер: 37201 байт
🔍 [DEBUG] Smart template bytes размер: 37234 байт
🔍 [DEBUG] Исходный файл размер: 40958 байт
✅ [DEBUG] Preview bytes отличается от исходного файла по размеру
```

### Финальная проверка:
```
🔍 [DEBUG] Проверяю содержимое preview_bytes перед отправкой...
🔍 [DEBUG] Preview bytes содержит 0 полей: []
🔍 [DEBUG] Preview bytes текст (первые 200 символов):                                     Договор подряда № 10-09-25/СКСг. Екатеринбург                                                                                   «15» сентября 2025 годаОбщество с ограниченной ответственностью...
🔍 [DEBUG] Создан preview_file с именем: preview_Договор_с_ИП_Молозин_П_Ю_СКС_версия_4.docx
🔍 [DEBUG] preview_file размер: 37201 байт
🔍 [DEBUG] Файл отправлен пользователю
🔍 [DEBUG] Отправленный файл: preview_Договор_с_ИП_Молозин_П_Ю_СКС_версия_4.docx
🔍 [DEBUG] Размер отправленного файла: 37201 байт
```

## Итоговый результат

### Успешно выполнено:
1. ✅ Загрузка и валидация файла (40,958 байт)
2. ✅ Детальная индексация (307 run'ов)
3. ✅ Анализ таблиц (1 таблица 2x2)
4. ✅ Отправка в Gemini AI (15,092 символа промпта)
5. ✅ Получение ответа (562 символа JSON)
6. ✅ Парсинг плана правок (10 полей)
7. ✅ Создание независимых копий документа
8. ✅ Применение хирургических правок
9. ✅ Сохранение результатов (37,201 + 37,234 байт)
10. ✅ Отправка preview пользователю

### Определенные поля:
- **9 полей реквизитов** (run-282, run-283, run-285, run-287, run-289, run-291, run-292, run-295, run-296)
- **1 поле подписи** (run-302)

### Проблемы:
- ⚠️ Поля не найдены в preview документе после изменений (возможная проблема с применением правок)

### Время выполнения:
- Общее время: ~30 секунд
- Основное время: анализ Gemini AI и хирургические правки

## Заключение

Процесс обработки документа прошел успешно с незначительными проблемами в финальной проверке. Система корректно:
1. Проанализировала структуру документа
2. Определила поля для заполнения
3. Создала два варианта документа (preview и smart template)
4. Применила изменения на уровне отдельных текстовых фрагментов

Результат готов для использования в системе генерации документов.
