# –§–∏–Ω–∞–ª—å–Ω–∞—è –µ–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —è–∑—ã–∫–∞

## üéØ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞

–°–æ–∑–¥–∞–Ω–∞ **–µ–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —è–∑—ã–∫–∞**, –∫–æ—Ç–æ—Ä–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —è–∑—ã–∫ –∏–∑ Firestore –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### 1. Middleware –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è user_id
**–§–∞–π–ª:** `utils/language_middleware.py`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `user_id` –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö

### 2. –£–ª—É—á—à–µ–Ω–Ω—ã–π LocaleManager
**–§–∞–π–ª:** `config/locales/locale_manager.py`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —è–∑—ã–∫ –∏–∑ Firestore
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π `user_id` –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- Fallback –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫

### 3. –ë–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
**–§–∞–π–ª—ã:** `handlers/base_message_handler.py`, `handlers/base_callback_handler.py`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç `user_id` –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
- –í—Å–µ –º–µ—Ç–æ–¥—ã `get_text()` —Ä–∞–±–æ—Ç–∞—é—Ç —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π —è–∑—ã–∫–∞

## üîß –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –®–∞–≥ 1: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ user_id
```python
# –í –∫–∞–∂–¥–æ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:
self.save_user_context(update, context)
# –≠—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç user_id –≤ context.user_data['_current_user_id']
```

### –®–∞–≥ 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —è–∑—ã–∫–∞
```python
# –ü—Ä–∏ –ª—é–±–æ–º –≤—ã–∑–æ–≤–µ get_text():
text = self.get_text("welcome.start_message", context)
# LocaleManager –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
# 1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç context.user_data['language']
# 2. –ï—Å–ª–∏ –Ω–µ—Ç, –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏–∑ Firestore –∏—Å–ø–æ–ª—å–∑—É—è _current_user_id
# 3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
```

### –®–∞–≥ 3: –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
- –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –æ–¥–Ω–æ–º —è–∑—ã–∫–µ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞
- –ù–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π —è–∑—ã–∫–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞

## üìã –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 1. –ù–æ–≤—ã–π middleware
```python
# utils/language_middleware.py
def save_user_id_to_context(update, context):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç user_id –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"""
    if update and hasattr(update, 'effective_user') and context:
        user_id = getattr(update.effective_user, 'id', None)
        if user_id and hasattr(context, 'user_data'):
            context.user_data['_current_user_id'] = user_id
```

### 2. –£–ª—É—á—à–µ–Ω–Ω—ã–π LocaleManager
```python
# config/locales/locale_manager.py
def get_language_from_context(self, context, update=None):
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç context.user_data['language']
    # 2. –ï—Å–ª–∏ –Ω–µ—Ç, –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏–∑ Firestore –∏—Å–ø–æ–ª—å–∑—É—è:
    #    - update.effective_user.id (–µ—Å–ª–∏ –µ—Å—Ç—å)
    #    - context.user_data['_current_user_id'] (–µ—Å–ª–∏ –Ω–µ—Ç update)
    # 3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
```

### 3. –ë–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
```python
# handlers/base_message_handler.py
def save_user_context(self, update, context):
    """Save user_id to context for language loading"""
    if update and context:
        save_user_id_to_context(update, context)
```

### 4. –û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
```python
# handlers/message_handlers.py
async def start(self, update, context):
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º user_id –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
    self.save_user_context(update, context)
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ Firestore
    current_language = self.locale_manager.get_language_from_context(context, update)
    
    # –í—Å–µ –≤—ã–∑–æ–≤—ã get_text() —Ä–∞–±–æ—Ç–∞—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    text = self.get_text("welcome.start_message", context, user="UserName")
```

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ùå –ü–µ—Ä–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- ‚ùå –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —è–∑—ã–∫–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–æ–∫
- ‚ùå –ù—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –æ—Ç–¥–µ–ª—å–Ω–æ

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —è–∑—ã–∫–µ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞
- ‚úÖ –ù–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π —è–∑—ã–∫–∞
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
- ‚úÖ –ï–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º —è–∑—ã–∫–æ–º
1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start` –±–æ—Ç—É
2. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å—Ä–∞–∑—É –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ

### –¢–µ—Å—Ç 2: –ê–Ω–∞–ª–∏–∑ —á–µ–∫–∞
1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —á–µ–∫–∞
2. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —è–∑—ã–∫–µ
3. –ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–Ω–æ–ø–∫—É
4. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ —Ç–æ–º –∂–µ —è–∑—ã–∫–µ

### –¢–µ—Å—Ç 3: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –±–æ—Ç–∞
1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start`
3. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å—Ä–∞–∑—É –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ

## üîç –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

–°–∏—Å—Ç–µ–º–∞ –≤—ã–≤–æ–¥–∏—Ç –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
```
DEBUG: Saved user_id 12345 to context
DEBUG: Loading language from Firestore for user 12345
DEBUG: Retrieved language from Firestore: 'en'
DEBUG: Language 'en' saved to context for user 12345
```

## üéâ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ï–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞** - –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞** - –Ω–µ –Ω—É–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å –æ –∑–∞–≥—Ä—É–∑–∫–µ —è–∑—ã–∫–∞
3. **–ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏** - –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —è–∑—ã–∫–∏
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —è–∑—ã–∫–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
5. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - fallback –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫

–¢–µ–ø–µ—Ä—å –≤–∞—à –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —è–∑—ã–∫–µ –≤–æ –≤—Å–µ—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è—Ö!

