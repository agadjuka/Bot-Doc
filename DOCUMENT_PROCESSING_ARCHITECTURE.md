# Архитектура обработки Word документов в Telegram боте

## Обзор системы

Бот предназначен для автоматического анализа Word документов и создания из них "умных шаблонов" с полями для заполнения. Основная цель - преобразовать обычные документы в шаблоны, где места для заполнения данных автоматически определяются и помечаются.

## Основные компоненты

### 1. TemplateProcessorService (`services/template_processor_service.py`)
**Главный сервис обработки документов**

#### Основные методы:
- `analyze_and_prepare_templates()` - главный метод обработки
- `_index_runs_and_build_map()` - создание детальной карты документа
- `_apply_edits_to_runs()` - применение изменений к документу
- `_send_gemini_request()` - отправка запроса в Gemini AI
- `_parse_gemini_edits_plan()` - парсинг ответа от Gemini

#### Ключевые особенности:
- **Run-level анализ**: Документ разбивается на мельчайшие текстовые фрагменты (runs)
- **Хирургические правки**: Изменения применяются точечно к конкретным run'ам
- **Двойная копия**: Создаются два независимых документа (preview и smart template)

### 2. TemplateManagementHandler (`handlers/template_management_handler.py`)
**Обработчик загрузки и управления шаблонами**

#### Основные методы:
- `handle_template_upload()` - обработка загруженного файла
- `handle_template_name_and_save()` - сохранение шаблона
- `start_template_upload()` - инициация процесса загрузки

### 3. PromptManager (`config/prompts.py`)
**Управление промптами для Gemini AI**

#### Ключевые промпты:
- `get_document_analysis_prompt()` - основной промпт для анализа документов
- `get_company_info_extraction_prompt()` - извлечение данных компании

## Процесс обработки документа

### Этап 1: Загрузка и валидация
1. Пользователь загружает .docx/.doc файл через Telegram
2. Проверка формата файла
3. Скачивание файла в байты
4. Отправка сообщения "Анализирую шаблон..."

### Этап 2: Детальная индексация документа
1. **Загрузка документа** через `python-docx.Document()`
2. **Создание карты run'ов**:
   - Каждый текстовый фрагмент получает уникальный ID (`run-0`, `run-1`, etc.)
   - Создается словарь координат `coords_dictionary[run_id] = run_object`
   - Формируется текстовая карта для Gemini: `[run-0]текст[run-1]текст...`

#### Пример карты:
```
[run-0]    [run-1]                               [run-2] [run-3]Договор подряда [run-4]№ [run-5]10[run-6]-[run-7]0[run-8]9[run-9]-2[run-10]5[run-11]/[run-12]СКС
[run-13]г. Екатеринбург[run-14] [run-15]        [run-16]        [run-17]        [run-18]        [run-19]        [run-20]        [run-21]        [run-22]        [run-23] [run-24]         
      [run-25] [run-26] [run-27] [run-28]             [run-29]  [run-30]     [run-31]  [run-32]«[run-33]1[run-34]5[run-35]» [run-36]сентября[run-37] [run-38]20[run-39]2[run-40]5[run-41] года
```

### Этап 3: Анализ таблиц
1. **Поиск таблиц** в документе
2. **Анализ структуры**:
   - Количество строк и столбцов
   - Ячейки с содержимым vs пустые ячейки
   - Ячейки с подчеркиваниями (кандидаты на поля)
3. **Логирование статистики** таблиц

### Этап 4: Отправка в Gemini AI
1. **Создание промпта** с картой документа
2. **Отправка запроса** в Gemini 2.5 Flash
3. **Получение JSON-ответа** с планом правок

#### Промпт для Gemini:
```
Ты — AI-юрист, эксперт по анализу юридических документов. Тебе предоставлена детальная карта документа, где каждый мельчайший текстовый фрагмент (`run`) имеет уникальный ID в формате `[run-ID]`.

**КАРТА ДОКУМЕНТА:**
---
[карта документа]
---

**ТВОЯ ЗАДАЧА:**
Проанализируй документ и найди все поля, которые должны быть заполнены данными. Определи, к какому из трех типов относится каждое поле:

1. **"наименование организации"** - название компании, организации
2. **"реквизиты"** - все официальные данные организации (ИНН, ОГРН, юридический адрес, телефон, банковские реквизиты и т.д.)
3. **"ФИО представителя"** - имя, фамилия, отчество представителя организации

**КРИТИЧЕСКИ ВАЖНО - ОБРАБОТКА БЛОКОВ:**
- Если видишь **непрерывный блок** подчеркиваний (`_______`) или желтых выделений, который предназначен для реквизитов, то:
  - **Первый `run` в этом блоке** замени на "реквизиты"
  - **Остальные `run`-ы в этом же блоке** замени на пустую строку (очисти их)
  - **НЕ ТРОГАЙ** другие части строки, которые не являются частью этого блока
- Если это блок для названия компании:
  - **Первый `run` в этом блоке** замени на "наименование организации"
  - **Остальные `run`-ы в этом же блоке** замени на пустую строку (очисти их)
  - **НЕ ТРОГАЙ** другие части строки
- Если это блок для имени представителя:
  - **Первый `run` в этом блоке** замени на "ФИО представителя"
  - **Остальные `run`-ы в этом же блоке** замени на пустую строку (очисти их)
  - **НЕ ТРОГАЙ** другие части строки

**ПРАВИЛА ОБРАБОТКИ:**
- Заменяй **только непрерывные блоки** подчеркиваний или выделений
- Если в строке несколько отдельных блоков - обрабатывай каждый отдельно
- Если между блоками есть обычный текст - **НЕ ТРОГАЙ** его
- В результате блок должен содержать **только одно название поля**, остальные `run`-ы в блоке очищаются

**ПРИМЕР РЕЗУЛЬТАТА:**
```json
[
  { "run_id": "run-25", "field_name": "наименование организации" },
  { "run_id": "run-26", "field_name": "" },
  { "run_id": "run-27", "field_name": "" },
  { "run_id": "run-156", "field_name": "реквизиты" },
  { "run_id": "run-157", "field_name": "" },
  { "run_id": "run-200", "field_name": "ФИО представителя" }
]
```

**ОБЪЯСНЕНИЕ ПРИМЕРА:**
- `run-25` - первый `run` в блоке подчеркиваний для названия организации → "наименование организации"
- `run-26`, `run-27` - остальные `run`-ы в том же блоке → очищаются (пустая строка)
- `run-156` - первый `run` в блоке подчеркиваний для реквизитов → "реквизиты"  
- `run-157` - остальной `run` в том же блоке реквизитов → очищается
- `run-200` - отдельный блок для ФИО → "ФИО представителя"
```

### Этап 5: Парсинг ответа Gemini
1. **Очистка ответа** (удаление markdown форматирования)
2. **Извлечение JSON** из ответа
3. **Валидация структуры** (проверка наличия `run_id` и `field_name`)
4. **Фильтрация валидных правок**

### Этап 6: Хирургические правки документа
1. **Создание независимых копий**:
   - Preview документ (для пользователя)
   - Smart template документ (для хранения)
2. **Перестройка координат** для каждой копии
3. **Удаление желтой заливки** из preview документа
4. **Применение правок**:
   - Preview: `[название_поля]` (красный, жирный)
   - Smart template: `{{название_поля}}`

#### Процесс применения правки:
```python
# Для preview документа
preview_run.clear()
preview_run.add_text(f"[{field_name}]")
preview_run.font.color.rgb = RGBColor(255, 0, 0)  # Красный
preview_run.bold = True

# Для smart template документа
smart_template_run.clear()
smart_template_run.add_text(f"{{{{{field_name}}}}}")
```

### Этап 7: Сохранение результатов
1. **Сохранение в байты**:
   - Preview документ → `preview_bytes`
   - Smart template документ → `smart_template_bytes`
2. **Проверка изменений** (размер файлов должен отличаться)
3. **Отправка preview** пользователю
4. **Сохранение smart template** в облачное хранилище

## Система типов полей

### Три типа полей:
1. **"наименование организации"** - название компании, организации
2. **"реквизиты"** - все официальные данные организации (ИНН, ОГРН, юридический адрес, телефон, банковские реквизиты и т.д.)
3. **"ФИО представителя"** - имя, фамилия, отчество представителя организации

### Логика обработки:
- Все поля типа "реквизиты" получают одинаковое название без нумерации
- Это позволяет заменить всю зону реквизитов одним плейсхолдером
- Пример: 9 полей `run-282`, `run-283`, etc. → все становятся `[реквизиты]`
- При замене полностью удаляются все подчеркивания, желтые выделения и другой текст

### Обработка таблиц:
- Анализируется структура таблиц
- Если таблица предназначена для реквизитов, каждая строка заменяется на "реквизиты"
- Подсчитываются пустые ячейки и ячейки с подчеркиваниями
- Создается отчет о покрытии реквизитами

## Технические детали

### Зависимости:
- `python-docx` - работа с Word документами
- `google-generativeai` - интеграция с Gemini AI
- `google.oauth2.service_account` - аутентификация Google Cloud
- `docx2txt` - извлечение текста из .doc файлов
- `docx2markdown` - конвертация в Markdown

### Обработка ошибок:
- Множественные стратегии парсинга JSON
- Проверка независимости копий документов
- Валидация изменений после применения
- Детальное логирование каждого этапа

### Производительность:
- Использование BytesIO для работы в памяти
- Минимизация копирования данных
- Асинхронная обработка запросов к Gemini

## Логирование

Система использует детальное логирование с префиксами:
- `[ANALYZE]` - анализ документа
- `[INDEX]` - индексация run'ов
- `[GEMINI]` - работа с AI
- `[PARSE]` - парсинг ответов
- `[SURGERY]` - применение правок
- `[HIGHLIGHT]` - работа с форматированием
- `[DEBUG]` - отладочная информация

## Результат работы

### Preview документ:
- Красные поля `[название_поля]` для визуального контроля
- Удалена желтая заливка
- Сохранено оригинальное форматирование

### Smart template документ:
- Плейсхолдеры `{{название_поля}}` для программной обработки
- Готов для использования в системе генерации документов
- Сохранен в облачном хранилище

## Примеры использования

### Успешная обработка:
1. Документ: "Договор_с_ИП_Молозин_П_Ю_СКС_версия_4.docx" (40958 байт)
2. Создано: 307 run'ов
3. Найдено: 1 таблица (2x2)
4. Определено: 9 полей реквизитов + 1 поле подписи
5. Результат: Preview (37201 байт) + Smart template (37234 байт)

### Типичные поля:
- `[реквизиты]` - для банковских и юридических данных
- `[Подпись Заказчика]` - для подписей
- `[Наименование организации]` - для названий компаний
- `[Имя руководителя]` - для ФИО директоров
