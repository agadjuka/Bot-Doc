# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Å–∏—Å—Ç–µ–º–µ –∞–Ω–∞–ª–∏–∑–∞ —á–µ–∫–æ–≤ –∏ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ–∫–æ–≤ –∏ –≤—ã–±–∏—Ä–∞–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â—É—é –º–æ–¥–µ–ª—å Gemini –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:
- **Flash –º–æ–¥–µ–ª—å** - –¥–ª—è –ø–µ—á–∞—Ç–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–±—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞)
- **Pro –º–æ–¥–µ–ª—å** - –¥–ª—è —Ä—É–∫–æ–ø–∏—Å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è)

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. –§—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ `analyze_receipt_and_choose_model`

**–§–∞–π–ª:** `utils/receipt_analyzer.py`

**–§—É–Ω–∫—Ü–∏—è:**
```python
async def analyze_receipt_and_choose_model(image_bytes: bytes) -> str
```

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- `'flash'` - –¥–ª—è –ø–µ—á–∞—Ç–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
- `'pro'` - –¥–ª—è —Ä—É–∫–æ–ø–∏—Å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞

**–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã:**

1. **–ü–æ–∏—Å–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é `find_text_regions()`
2. **–ê–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞:**
   - –í—ã—Ä–µ–∑–∞–µ—Ç ROI (Region of Interest) –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   - –ü—Ä–∏–º–µ–Ω—è–µ—Ç –∞–¥–∞–ø—Ç–∏–≤–Ω—É—é –±–∏–Ω–∞—Ä–∏–∑–∞—Ü–∏—é –¥–ª—è —á–µ—Ç–∫–æ—Å—Ç–∏ –∫–æ–Ω—Ç—É—Ä–æ–≤
   - –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–ª–æ—Ç–Ω–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ (–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —á–µ—Ä–Ω—ã—Ö –ø–∏–∫—Å–µ–ª–µ–π –∫ –æ–±—â–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É)
   - –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç–æ–ª—â–∏–Ω—ã –ª–∏–Ω–∏–π —Å –ø–æ–º–æ—â—å—é –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
3. **–ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è:**
   - –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç "–ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ" –±–ª–æ–∫–∏ (—Å –≤—ã—Å–æ–∫–æ–π –ø–ª–æ—Ç–Ω–æ—Å—Ç—å—é –∏–ª–∏ –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å—é)
   - –ï—Å–ª–∏ –¥–æ–ª—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –±–ª–æ–∫–æ–≤ > 20% ‚Üí –º–æ–¥–µ–ª—å PRO
   - –ò–Ω–∞—á–µ ‚Üí –º–æ–¥–µ–ª—å FLASH

### 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ –∞–Ω–∞–ª–∏–∑–∞

**–§–∞–π–ª:** `config/settings.py`

**–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è:**
```python
self.GEMINI_ANALYSIS_MODE: str = os.getenv("GEMINI_ANALYSIS_MODE", "production")
```

**–†–µ–∂–∏–º—ã:**
- `"production"` - –ø–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª—å—é
- `"debug"` - —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ PhotoHandler

**–§–∞–π–ª:** `handlers/photo_handler.py`

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**
1. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ–∫–∞
2. –í—ã–±–∏—Ä–∞–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â—É—é –º–æ–¥–µ–ª—å
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–∂–∏–º –∞–Ω–∞–ª–∏–∑–∞:
   - **Debug —Ä–µ–∂–∏–º:** –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª—å—é –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É
   - **Production —Ä–µ–∂–∏–º:** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å –¥–ª—è –ø–æ–ª–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–∂–∏–º–∞ –æ—Ç–ª–∞–¥–∫–∏

**–ß–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
```bash
export GEMINI_ANALYSIS_MODE=debug
```

**–í –∫–æ–¥–µ:**
```python
import os
os.environ["GEMINI_ANALYSIS_MODE"] = "debug"
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:**
```bash
python test_receipt_analyzer.py
python test_debug_mode.py
```

## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–ª–≥–æ—Ä–∏—Ç–º–∞

### –ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä—É–∫–æ–ø–∏—Å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞:

- **–ü–ª–æ—Ç–Ω–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞:** > 0.15 (15%)
- **–í–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç–æ–ª—â–∏–Ω—ã:** > 0.05 (5%)
- **–û–±—â–∏–π –ø–æ—Ä–æ–≥ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –±–ª–æ–∫–æ–≤:** > 0.2 (20%)

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:

- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞:** 1000 –ø–∏–∫—Å–µ–ª–µ–π
- **–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –±–∏–Ω–∞—Ä–∏–∑–∞—Ü–∏—è:** `ADAPTIVE_THRESH_GAUSSIAN_C` —Å –±–ª–æ–∫–æ–º 11x11
- **–ú–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç:** `MORPH_RECT` 3x3

## –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã

### –ü–µ—á–∞—Ç–Ω—ã–π —á–µ–∫
```
üîç –ù–∞–π–¥–µ–Ω–æ 15 —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤
üîç –ë–ª–æ–∫ 1: –ø–µ—á–∞—Ç–Ω—ã–π (–ø–ª–æ—Ç–Ω–æ—Å—Ç—å: 0.08, –≤–∞—Ä–∏–∞—Ü–∏—è: 0.02)
üîç –ë–ª–æ–∫ 2: –ø–µ—á–∞—Ç–Ω—ã–π (–ø–ª–æ—Ç–Ω–æ—Å—Ç—å: 0.12, –≤–∞—Ä–∏–∞—Ü–∏—è: 0.03)
...
üîç –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω: 2/15 –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –±–ª–æ–∫–æ–≤ (13.33%)
üñ®Ô∏è –í—ã–±—Ä–∞–Ω–∞ –º–æ–¥–µ–ª—å FLASH (–ø–µ—á–∞—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç)
```

### –†—É–∫–æ–ø–∏—Å–Ω—ã–π —á–µ–∫
```
üîç –ù–∞–π–¥–µ–Ω–æ 39 —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤
üîç –ë–ª–æ–∫ 1: –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π (–ø–ª–æ—Ç–Ω–æ—Å—Ç—å: 0.48, –≤–∞—Ä–∏–∞—Ü–∏—è: 0.52)
üîç –ë–ª–æ–∫ 2: –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π (–ø–ª–æ—Ç–Ω–æ—Å—Ç—å: 0.35, –≤–∞—Ä–∏–∞—Ü–∏—è: 0.12)
...
üîç –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω: 37/39 –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –±–ª–æ–∫–æ–≤ (94.87%)
‚úçÔ∏è –í—ã–±—Ä–∞–Ω–∞ –º–æ–¥–µ–ª—å PRO (—Ä—É–∫–æ–ø–∏—Å–Ω—ã–π —Ç–µ–∫—Å—Ç)
```

## –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏ –∞–Ω–∞–ª–∏–∑–∞
–°–∏—Å—Ç–µ–º–∞ –≤—ã–≤–æ–¥–∏—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞–Ω–∞–ª–∏–∑–∞:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤
- –ê–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
- –ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∏ –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å

### –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏
–í —Ä–µ–∂–∏–º–µ `debug` —Å–∏—Å—Ç–µ–º–∞:
1. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
2. –í—ã–±–∏—Ä–∞–µ—Ç –º–æ–¥–µ–ª—å
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
4. **–ù–ï –≤—ã–ø–æ–ª–Ω—è–µ—Ç** –ø–æ–ª–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞:** ~1-3 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- **–¢–æ—á–Ω–æ—Å—Ç—å:** –≤—ã—Å–æ–∫–∞—è –¥–ª—è —á–µ—Ç–∫–∏—Ö —Ä–∞–∑–ª–∏—á–∏–π –º–µ–∂–¥—É –ø–µ—á–∞—Ç–Ω—ã–º –∏ —Ä—É–∫–æ–ø–∏—Å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
- **–ü–∞–º—è—Ç—å:** –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –±–ª–∞–≥–æ–¥–∞—Ä—è –æ–±—Ä–∞–±–æ—Ç–∫–µ ROI

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–ö–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:** —Ç—Ä–µ–±—É–µ—Ç —á–µ—Ç–∫–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
2. **–°–º–µ—à–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:** –º–æ–∂–µ—Ç –æ—à–∏–±–æ—á–Ω–æ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ —Å–º–µ—à–µ–Ω–∏–∏ –ø–µ—á–∞—Ç–Ω–æ–≥–æ –∏ —Ä—É–∫–æ–ø–∏—Å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
3. **–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞:** –æ—á–µ–Ω—å –º–µ–ª–∫–∏–π —Ç–µ–∫—Å—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ML –º–æ–¥–µ–ª–µ–π –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
2. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:** –∞–Ω–∞–ª–∏–∑ –≥–µ–æ–º–µ—Ç—Ä–∏–∏ —Å–∏–º–≤–æ–ª–æ–≤, –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç–∏
3. **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–æ—Ä–æ–≥–∏:** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä–æ–≥–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
4. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:** —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –ø–æ—Ö–æ–∂–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π