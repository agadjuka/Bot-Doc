# Улучшенный процесс обработки документов с GEMINI

## Обзор изменений

Система была значительно улучшена для качественного анализа таблиц и обработки реквизитов. Теперь GEMINI получает максимально детальную информацию о структуре документа и может качественно определять размеры таблиц.

## Новый процесс обработки

```
1. ЗАГРУЗКА ДОКУМЕНТА
   ↓
2. АНАЛИЗ СТРУКТУРЫ ТАБЛИЦ
   - Определение количества таблиц
   - Анализ размеров (строки x столбцы)
   - Подсчет пустых ячеек, ячеек с подчеркиваниями
   - Выявление ячеек с пробелами
   ↓
3. ДЕТАЛЬНАЯ ИНДЕКСАЦИЯ НА УРОВНЕ RUN-ОВ
   - Создание карты документа с уникальными ID
   - Добавление маркеров структуры таблиц
   - Указание позиций ячеек [ЯЧЕЙКА row,col]
   - Разделители строк и столбцов
   ↓
4. УЛУЧШЕННЫЙ ПРОМПТ ДЛЯ GEMINI
   - Детальные инструкции по анализу таблиц
   - Требование определить ВСЕ размеры таблиц
   - Инструкции по замене пустых строк на "реквизиты"
   - Максимальная работа GEMINI по анализу структуры
   ↓
5. ОТПРАВКА В GEMINI
   - Передача детальной карты документа
   - Получение плана правок с полями "реквизиты"
   ↓
6. ПАРСИНГ ОТВЕТА GEMINI
   - Извлечение плана правок
   - Подсчет полей реквизитов
   - Валидация структуры ответа
   ↓
7. ПРИМЕНЕНИЕ ХИРУРГИЧЕСКИХ ПРАВОК
   - Замена пустых строк на "[реквизиты]"
   - Сохранение структуры таблиц
   - Создание preview и smart template
   ↓
8. СОЗДАНИЕ ОТЧЕТА
   - Анализ обработанных полей реквизитов
   - Статистика по таблицам
   - Покрытие пустых ячеек
```

## Ключевые улучшения

### 1. Улучшенный промпт для GEMINI
- **Детальный анализ таблиц**: GEMINI должен определить ВСЕ размеры таблиц качественно
- **Обработка пустых строк**: ВСЕ пустые строки в зоне реквизитов заменяются на "реквизиты"
- **Максимальная работа GEMINI**: Передача максимального объема работы на уровень AI
- **Качественное определение границ**: Каждая строка анализируется отдельно

### 2. Улучшенная индексация документа
- **Структурные маркеры**: `=== ТАБЛИЦА N (СТРОК: X, СТОЛБЦОВ: Y) ===`
- **Маркеры строк**: `--- СТРОКА N ---`
- **Маркеры ячеек**: `[ЯЧЕЙКА row,col]`
- **Разделители**: `|` между ячейками, `\n` между строками

### 3. Анализ структуры таблиц
- **Предварительный анализ**: Подсчет пустых ячеек, ячеек с подчеркиваниями
- **Статистика по таблицам**: Размеры, количество содержимого
- **Выявление паттернов**: Поиск зон реквизитов

### 4. Улучшенная обработка реквизитов
- **Единая зона**: Все поля реквизитов помечаются как "реквизиты" без нумерации
- **Замена пустых строк**: ВСЕ пустые строки в зоне реквизитов заменяются на "реквизиты"
- **Сохранение структуры**: Таблицы остаются наглядными и структурированными

### 5. Детальный отчет
- **Статистика полей**: Количество полей реквизитов vs других полей
- **Анализ таблиц**: Размеры, количество пустых ячеек
- **Покрытие**: Сколько пустых ячеек покрыто полями реквизитов

## Результат

Теперь система обеспечивает:
- ✅ **Качественное определение размеров таблиц** GEMINI
- ✅ **Максимальную наглядность** каждой строки таблицы
- ✅ **Автоматическую замену пустых строк** на "реквизиты"
- ✅ **Единую зону реквизитов** без дробления на отдельные поля
- ✅ **Максимальную работу GEMINI** с минимальной обработкой на сервере
- ✅ **Детальную отчетность** о процессе обработки

## Использование

Система автоматически применяет все улучшения при обработке документов через `TemplateProcessorService.analyze_and_prepare_templates()`. Никаких дополнительных настроек не требуется.

## Логирование

Все этапы процесса подробно логируются с префиксами:
- `[TABLE_ANALYSIS]` - анализ структуры таблиц
- `[INDEX]` - индексация документа
- `[GEMINI]` - работа с GEMINI AI
- `[PARSE]` - парсинг ответа
- `[SURGERY]` - применение правок
- `[REQUISITES]` - обработка реквизитов
- `[REPORT]` - создание отчета
