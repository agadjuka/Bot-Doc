# –û—Ç—á–µ—Ç –æ —Ä–∞–∑–ª–∏—á–∏—è—Ö –º–µ–∂–¥—É –ª–æ–∫–∞–ª—å–Ω–æ–π –∏ –æ–±–ª–∞—á–Ω–æ–π –≤–µ—Ä—Å–∏—è–º–∏

## –û–±–∑–æ—Ä

–ü—Ä–æ–≤–µ–¥–µ–Ω–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ (`main_local.py`) –∏ –æ–±–ª–∞—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏ (`main.py`) —Å —Ü–µ–ª—å—é –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è **—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏** –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ **–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Ä–∞–∑–ª–∏—á–∏–π**, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ä–µ–¥ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è.

## –ö–ª—é—á–µ–≤—ã–µ —Ä–∞–∑–ª–∏—á–∏—è (–ø–æ –¥–∏–∑–∞–π–Ω—É)

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è

| –ê—Å–ø–µ–∫—Ç | –õ–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è | –û–±–ª–∞—á–Ω–∞—è –≤–µ—Ä—Å–∏—è |
|--------|------------------|-----------------|
| **–ü—Ä–æ—Ç–æ–∫–æ–ª** | Polling | Webhook (FastAPI) |
| **–ó–∞–ø—É—Å–∫** | –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π `main()` | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Å FastAPI |
| **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è** | `env.local` —Ñ–∞–π–ª | –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Cloud Run |
| **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** | `safe_start_bot()` —Å retry | Graceful degradation |
| **Keep-alive** | –ù–µ –Ω—É–∂–µ–Ω | –û–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è Cloud Run |
| **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** | –ö–æ–Ω—Å–æ–ª—å–Ω—ã–µ –ª–æ–≥–∏ | FastAPI endpoints |

### 2. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

**–õ–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–æ–ª–∂–Ω–∞:**
- –†–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ polling
- –ó–∞–≥—Ä—É–∂–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ `.env` —Ñ–∞–π–ª–∞
- –ò–º–µ—Ç—å retry –ª–æ–≥–∏–∫—É –¥–ª—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- –ë—ã—Ç—å –ø—Ä–æ—Å—Ç–æ–π –≤ –æ—Ç–ª–∞–¥–∫–µ

**–û–±–ª–∞—á–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–æ–ª–∂–Ω–∞:**
- –†–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ webhook
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ò–º–µ—Ç—å keep-alive –¥–ª—è Cloud Run
- –ë—ã—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è production

## –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ `AWAITING_INPUT` –≤ –æ–±–ª–∞—á–Ω—É—é –≤–µ—Ä—Å–∏—é

```python
states={
    config.AWAITING_INPUT: [
        MessageHandler(filters.TEXT & ~filters.COMMAND, message_handlers.handle_text),
        CommandHandler("help", message_handlers.help_command),
        CommandHandler("new_contract", document_handlers.new_contract_command)
    ],
    config.AWAITING_COMPANY_INFO: [
        MessageHandler(filters.TEXT & ~filters.COMMAND, document_handlers.handle_company_info),
        CommandHandler("cancel", document_handlers.cancel_document_creation)
    ],
},
```

### 2. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è Cloud Run

```python
async def initialize_bot():
    """Initialize the bot application and start background tasks for Cloud Run"""
    # –ü—Ä—è–º–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–µ–∑ retry (Cloud Run —Å–∞–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç)
    # Keep-alive –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞—Å—ã–ø–∞–Ω–∏—è
    # Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω endpoint —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

```python
@app.get("/status")
async def cloud_status():
    """–°—Ç–∞—Ç—É—Å –æ–±–ª–∞—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –±–æ—Ç–∞ –¥–ª—è Cloud Run"""
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    # –°—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

### ‚úÖ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞

–û–±–µ –≤–µ—Ä—Å–∏–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç **–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç**:

1. **ConversationHandler** —Å –ø–æ–ª–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–π
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥** `/start`, `/help`, `/new_contract`
3. **–°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** —á–µ—Ä–µ–∑ –¥–∏–∞–ª–æ–≥
4. **–ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞** —á–µ—Ä–µ–∑ LocaleManager
5. **AI –æ–±—Ä–∞–±–æ—Ç–∫–∞** —á–µ—Ä–µ–∑ AIService

### üîß –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã

**–õ–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è:**
- Polling –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- `.env` —Ñ–∞–π–ª—ã –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- Retry –ª–æ–≥–∏–∫–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
- –ü—Ä–æ—Å—Ç–∞—è –æ—Ç–ª–∞–¥–∫–∞

**–û–±–ª–∞—á–Ω–∞—è –≤–µ—Ä—Å–∏—è:**
- Webhook –¥–ª—è production
- –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- Keep-alive –¥–ª—è Cloud Run
- FastAPI endpoints –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–±–ª–∞—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ endpoint:

```bash
GET /status
```

–û—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã:

```json
{
  "version": "cloud",
  "environment": "Cloud Run",
  "protocol": "webhook",
  "components": {
    "application_initialized": true,
    "firestore_connected": true,
    "keep_alive_running": true,
    "locale_manager": true,
    "ai_service": true,
    "handlers": true
  },
  "status": "operational"
}
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–û–±–ª–∞—á–Ω–∞—è –∏ –ª–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏–∏ —Ç–µ–ø–µ—Ä—å **—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–æ **–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã** –¥–ª—è —Å–≤–æ–∏—Ö —Å—Ä–µ–¥ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

- **–ï–¥–∏–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç** –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –≤–µ—Ä—Å–∏–∏
- **–û–ø—Ç–∏–º–∞–ª—å–Ω—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** –≤ –∫–∞–∂–¥–æ–π —Å—Ä–µ–¥–µ
- **–ü—Ä–æ—Å—Ç–æ—Ç—É —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏** –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥–µ
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã** –≤ production
