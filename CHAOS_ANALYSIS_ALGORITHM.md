# Алгоритм анализа "индекса хаоса" для определения типа текста

## Описание

Реализован новый алгоритм анализа изображений чеков, который определяет тип текста (печатный или рукописный) путем вычисления "индекса хаоса" для каждой строки текста отдельно.

## Принцип работы

### 1. Подготовка изображения
- **Выравнивание**: Функция `straighten_receipt()` исправляет наклон изображения с помощью преобразования Хафа
- **Предобработка**: Изображение масштабируется до максимальной ширины 1000px для ускорения обработки

### 2. Поиск символов
- **Бинаризация**: Применяется адаптивная бинаризация для выделения контуров
- **Морфология**: Морфологические операции очищают изображение от шума
- **Детекция контуров**: Находятся все контуры символов с фильтрацией по размеру и форме

### 3. Группировка в строки
- **Сортировка**: Символы сортируются по Y-координате
- **Группировка**: Символы группируются в строки на основе вертикального расстояния
- **Критерий**: Максимальное расстояние = 50% от средней высоты символов в строке

### 4. Вычисление индекса хаоса

Для каждой строки вычисляется индекс хаоса на основе трех показателей:

#### 4.1 Стандартное отклонение высот символов
```python
height_chaos = height_std / avg_height
```

#### 4.2 Стандартное отклонение углов наклона
```python
angle_chaos = min(angle_std / 45.0, 1.0)
```

#### 4.3 Стандартное отклонение Y-координат центров
```python
center_y_chaos = center_y_std / avg_height
```

#### 4.4 Итоговый индекс хаоса
```python
chaos_index = (height_chaos * 0.4 + angle_chaos * 0.3 + center_y_chaos * 0.3)
```

### 5. Принятие решения

- **Порог**: `CHAOS_THRESHOLD = 0.7`
- **Логика**: Если хотя бы одна строка имеет индекс хаоса > порога → модель 'pro'
- **Иначе**: Все строки имеют низкий хаос → модель 'flash'

## Ключевые функции

### `straighten_receipt(image: np.ndarray) -> np.ndarray`
Выравнивает изображение чека, исправляя наклон.

### `find_character_contours(image: np.ndarray) -> List[Dict]`
Находит контуры всех отдельных символов на изображении.

### `group_characters_into_lines(characters: List[Dict]) -> List[List[Dict]]`
Группирует символы в строки на основе их Y-координаты.

### `calculate_chaos_index(line_characters: List[Dict]) -> float`
Вычисляет индекс хаоса для строки символов (0-1, где 1 - максимальный хаос).

### `analyze_receipt_and_choose_model(image_bytes: bytes) -> str`
Основная функция анализа, возвращает 'flash' или 'pro'.

## Преимущества нового алгоритма

1. **Точность**: Анализирует каждую строку отдельно, что повышает точность определения
2. **Чувствительность**: Может обнаружить даже одну рукописную строку среди печатного текста
3. **Надежность**: Использует множественные показатели хаоса для более точной оценки
4. **Производительность**: Немедленно возвращает результат при обнаружении рукописного текста

## Параметры настройки

- `CHAOS_THRESHOLD`: Порог для определения рукописного текста (по умолчанию 0.7)
- Веса показателей хаоса: высоты (0.4), углы (0.3), Y-координаты (0.3)
- Минимальное количество символов в строке для анализа: 2

## Тестирование

Создан тестовый скрипт `test_chaos_analysis.py` для проверки работы алгоритма на синтетических данных.

## Использование

```python
import asyncio
from utils.receipt_analyzer import analyze_receipt_and_choose_model

# Анализ изображения
with open('receipt.jpg', 'rb') as f:
    image_bytes = f.read()

model_choice = await analyze_receipt_and_choose_model(image_bytes)
print(f"Выбрана модель: {model_choice}")
```
